name: Build and Push Docker Images

on:
  push:
    branches:
      - main
      - master
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      version:
        description: 'é•œåƒç‰ˆæœ¬å·ï¼ˆå¦‚ v1.0.0ï¼‰'
        required: false
        default: 'latest'

env:
  # é•œåƒä»“åº“é…ç½®ï¼ˆéœ€è¦åœ¨ GitHub Secrets ä¸­é…ç½®ï¼‰
  REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
  PROJECT_NAME: dashboard

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•é•œåƒä»“åº“
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: æå–å…ƒæ•°æ®ï¼ˆæ ‡ç­¾ã€ç‰ˆæœ¬ç­‰ï¼‰
        id: meta
        run: |
          # ç¡®å®šç‰ˆæœ¬å·
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          elif [[ "${{ github.ref }}" == refs/heads/main ]] || [[ "${{ github.ref }}" == refs/heads/master ]]; then
            VERSION="latest"
          elif [[ "${{ github.ref }}" == refs/heads/develop ]]; then
            VERSION="dev"
          else
            VERSION="pr-${{ github.event.pull_request.number }}"
          fi
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "backend_image=${{ secrets.DOCKER_REGISTRY }}/${{ env.PROJECT_NAME }}-backend:${VERSION}" >> $GITHUB_OUTPUT
          echo "frontend_image=${{ secrets.DOCKER_REGISTRY }}/${{ env.PROJECT_NAME }}-frontend:${VERSION}" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ æž„å»ºç‰ˆæœ¬: ${VERSION}"

      - name: æž„å»ºå¹¶æŽ¨é€åŽç«¯é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.backend_image }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: æž„å»ºå¹¶æŽ¨é€å‰ç«¯é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.frontend_image }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: è¾“å‡ºé•œåƒä¿¡æ¯
        run: |
          echo "âœ… é•œåƒæž„å»ºå¹¶æŽ¨é€æˆåŠŸï¼"
          echo ""
          echo "ðŸ“¦ é•œåƒä¿¡æ¯ï¼š"
          echo "  åŽç«¯é•œåƒ: ${{ steps.meta.outputs.backend_image }}"
          echo "  å‰ç«¯é•œåƒ: ${{ steps.meta.outputs.frontend_image }}"
          echo ""
          echo "ðŸš€ éƒ¨ç½²å‘½ä»¤ï¼š"
          echo "  docker pull ${{ steps.meta.outputs.backend_image }}"
          echo "  docker pull ${{ steps.meta.outputs.frontend_image }}"

      - name: åˆ›å»ºéƒ¨ç½²è¯´æ˜Ž
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          cat > deployment-info.txt << EOF
          ================================================================================
                              Dashboard éƒ¨ç½²ä¿¡æ¯
          ================================================================================
          
          ç‰ˆæœ¬: ${{ steps.meta.outputs.version }}
          æž„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
          Git Commit: ${{ github.sha }}
          
          é•œåƒä¿¡æ¯:
            åŽç«¯: ${{ steps.meta.outputs.backend_image }}
            å‰ç«¯: ${{ steps.meta.outputs.frontend_image }}
          
          éƒ¨ç½²å‘½ä»¤:
            docker pull ${{ steps.meta.outputs.backend_image }}
            docker pull ${{ steps.meta.outputs.frontend_image }}
            docker-compose up -d
          
          ================================================================================
          EOF
          
          cat deployment-info.txt

      - name: ä¸Šä¼ éƒ¨ç½²è¯´æ˜Ž
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: deployment-info
          path: deployment-info.txt
