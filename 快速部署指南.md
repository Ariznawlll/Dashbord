# å¿«é€Ÿéƒ¨ç½²æŒ‡å— - Docker é•œåƒæ–¹å¼

## ðŸŽ¯ éƒ¨ç½²æµç¨‹æ¦‚è§ˆ

```
å¼€å‘æœºå™¨                    é•œåƒä»“åº“                    ç”Ÿäº§æœåŠ¡å™¨
   â”‚                          â”‚                          â”‚
   â”œâ”€ 1. æž„å»ºé•œåƒ              â”‚                          â”‚
   â”‚   ./build-images.sh      â”‚                          â”‚
   â”‚                          â”‚                          â”‚
   â”œâ”€ 2. æŽ¨é€é•œåƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
   â”‚   docker push            â”‚                          â”‚
   â”‚                          â”‚                          â”‚
   â”‚                          â”‚<â”€â”€â”€â”€ 3. æ‹‰å–é•œåƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                          â”‚      docker pull         â”‚
   â”‚                          â”‚                          â”‚
   â”‚                          â”‚                          â”œâ”€ 4. å¯åŠ¨æœåŠ¡
   â”‚                          â”‚                          â”‚   docker-compose up
   â”‚                          â”‚                          â”‚
   â”‚                          â”‚                          â”œâ”€ 5. è®¿é—®æœåŠ¡
   â”‚                          â”‚                          â”‚   http://server-ip
```

---

## ðŸ“‹ ç¬¬ä¸€æ­¥ï¼šåœ¨å¼€å‘æœºå™¨ä¸Šæž„å»ºé•œåƒ

### é€‰é¡¹ Aï¼šä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆæŽ¨èï¼‰

```bash
cd dashboard

# 1. é…ç½®é•œåƒä»“åº“åœ°å€
vim build-images.sh
# ä¿®æ”¹è¿™ä¸€è¡Œï¼š
# REGISTRY="your-registry.com"
# æ”¹ä¸ºä½ çš„å®žé™…åœ°å€ï¼Œä¾‹å¦‚ï¼š
# REGISTRY="harbor.company.com/project"

# 2. æž„å»ºé•œåƒ
./build-images.sh v1.0.0

# 3. æ ¹æ®æç¤ºé€‰æ‹©æ˜¯å¦æŽ¨é€ï¼ˆè¾“å…¥ yï¼‰
```

### é€‰é¡¹ Bï¼šæ‰‹åŠ¨æž„å»º

```bash
cd dashboard

# æž„å»ºåŽç«¯é•œåƒ
docker build -t harbor.company.com/project/dashboard-backend:v1.0.0 \
  -f backend/Dockerfile backend/

# æž„å»ºå‰ç«¯é•œåƒ
docker build -t harbor.company.com/project/dashboard-frontend:v1.0.0 \
  -f frontend/Dockerfile frontend/

# æŽ¨é€é•œåƒ
docker login harbor.company.com
docker push harbor.company.com/project/dashboard-backend:v1.0.0
docker push harbor.company.com/project/dashboard-frontend:v1.0.0
```

### é€‰é¡¹ Cï¼šä¿å­˜ä¸ºæ–‡ä»¶ï¼ˆæ— é•œåƒä»“åº“ï¼‰

```bash
cd dashboard

# æž„å»ºé•œåƒ
docker build -t dashboard-backend:v1.0.0 -f backend/Dockerfile backend/
docker build -t dashboard-frontend:v1.0.0 -f frontend/Dockerfile frontend/

# ä¿å­˜ä¸ºæ–‡ä»¶
docker save dashboard-backend:v1.0.0 -o dashboard-backend.tar
docker save dashboard-frontend:v1.0.0 -o dashboard-frontend.tar

# åŽ‹ç¼©
gzip dashboard-backend.tar
gzip dashboard-frontend.tar

# ä¼ è¾“åˆ°æœåŠ¡å™¨
scp dashboard-*.tar.gz user@server:/opt/dashboard/
```

---

## ðŸ“¦ ç¬¬äºŒæ­¥ï¼šåœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½²

### å‡†å¤‡å·¥ä½œ

```bash
# 1. åˆ›å»ºéƒ¨ç½²ç›®å½•
mkdir -p /opt/dashboard
cd /opt/dashboard

# 2. å¦‚æžœä½¿ç”¨æ–‡ä»¶æ–¹å¼ï¼Œå…ˆåŠ è½½é•œåƒ
gunzip dashboard-backend.tar.gz
gunzip dashboard-frontend.tar.gz
docker load -i dashboard-backend.tar
docker load -i dashboard-frontend.tar
```

### åˆ›å»ºé…ç½®æ–‡ä»¶

#### 1. åˆ›å»º docker-compose.yml

```bash
cat > docker-compose.yml << 'EOF'
version: '3.8'

services:
  backend:
    image: harbor.company.com/project/dashboard-backend:v1.0.0
    container_name: dashboard-backend
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
    env_file:
      - .env
    restart: always
    networks:
      - dashboard-network

  frontend:
    image: harbor.company.com/project/dashboard-frontend:v1.0.0
    container_name: dashboard-frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    restart: always
    networks:
      - dashboard-network

networks:
  dashboard-network:
    driver: bridge
EOF
```

#### 2. åˆ›å»º .env é…ç½®æ–‡ä»¶

```bash
cat > .env << 'EOF'
# Server
PORT=3001

# GitHubï¼ˆå¿…é¡»é…ç½®ï¼‰
GITHUB_TOKEN=ghp_your_token_here
GITHUB_REPO=matrixorigin/matrixone

# Loki æ—¥å¿—ç›‘æŽ§é…ç½®
LOKI_ENDPOINTS=[{"name":"TKEæµ‹è¯•æ—¥å¿—","url":"https://grafana.ci.matrixorigin.cn/..."},{"name":"å•æœºæµ‹è¯•æ—¥å¿—","url":"https://shanghai.idc.matrixorigin.cn:30001/..."}]

# æ€§èƒ½ç›‘æŽ§é…ç½®
PERFORMANCE_MONITORS=[{"category":"å•æœºæµ‹è¯•æ€§èƒ½","items":[...]},{"category":"åˆ†å¸ƒå¼æµ‹è¯•æ€§èƒ½","items":[...]}]
EOF

# ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œå¡«å…¥å®žé™…å€¼
vim .env
```

### å¯åŠ¨æœåŠ¡

```bash
# å¦‚æžœä½¿ç”¨é•œåƒä»“åº“ï¼Œå…ˆç™»å½•å¹¶æ‹‰å–
docker login harbor.company.com
docker-compose pull

# å¯åŠ¨æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f
```

---

## âœ… ç¬¬ä¸‰æ­¥ï¼šéªŒè¯éƒ¨ç½²

```bash
# 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker-compose ps
# åº”è¯¥çœ‹åˆ°ä¸¤ä¸ªå®¹å™¨éƒ½æ˜¯ Up çŠ¶æ€

# 2. æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://localhost:3001/health
# åº”è¯¥è¿”å›ž: {"status":"ok","timestamp":"..."}

# 3. è®¿é—®å‰ç«¯
curl http://localhost:80
# åº”è¯¥è¿”å›ž HTML å†…å®¹

# 4. åœ¨æµè§ˆå™¨è®¿é—®
# http://æœåŠ¡å™¨IP:80
```

---

## ðŸ”„ æ›´æ–°éƒ¨ç½²

```bash
cd /opt/dashboard

# 1. æ‹‰å–æ–°é•œåƒ
docker-compose pull

# 2. é‡å¯æœåŠ¡
docker-compose up -d

# 3. æ¸…ç†æ—§é•œåƒ
docker image prune -f
```

---

## ðŸ› ï¸ å¸¸ç”¨å‘½ä»¤

### æŸ¥çœ‹æ—¥å¿—
```bash
# å®žæ—¶æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
docker-compose logs -f

# åªçœ‹åŽç«¯æ—¥å¿—
docker-compose logs -f backend

# æŸ¥çœ‹æœ€è¿‘ 100 è¡Œ
docker-compose logs --tail=100
```

### é‡å¯æœåŠ¡
```bash
# é‡å¯æ‰€æœ‰æœåŠ¡
docker-compose restart

# åªé‡å¯åŽç«¯
docker-compose restart backend
```

### åœæ­¢æœåŠ¡
```bash
# åœæ­¢æœåŠ¡
docker-compose stop

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨
docker-compose down
```

### è¿›å…¥å®¹å™¨è°ƒè¯•
```bash
# è¿›å…¥åŽç«¯å®¹å™¨
docker-compose exec backend sh

# è¿›å…¥å‰ç«¯å®¹å™¨
docker-compose exec frontend sh
```

---

## ðŸ”§ æ•…éšœæŽ’æŸ¥

### é—®é¢˜ 1ï¼šå®¹å™¨å¯åŠ¨å¤±è´¥

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker-compose logs backend
docker-compose logs frontend

# æ£€æŸ¥é…ç½®æ–‡ä»¶
cat .env

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep 3001
netstat -tlnp | grep 80
```

### é—®é¢˜ 2ï¼šæ— æ³•è®¿é—®æœåŠ¡

```bash
# æ£€æŸ¥é˜²ç«å¢™
sudo ufw status
sudo ufw allow 80/tcp
sudo ufw allow 3001/tcp

# æ£€æŸ¥å®¹å™¨ç½‘ç»œ
docker network ls
docker network inspect dashboard_dashboard-network
```

### é—®é¢˜ 3ï¼šGitHub API é™æµ

```bash
# æ£€æŸ¥ token æ˜¯å¦é…ç½®
docker-compose exec backend sh -c 'echo $GITHUB_TOKEN'

# é‡å¯åŽç«¯ä½¿é…ç½®ç”Ÿæ•ˆ
docker-compose restart backend
```

---

## ðŸ“ å®Œæ•´ç¤ºä¾‹

### åœºæ™¯ï¼šä½¿ç”¨ Harbor é•œåƒä»“åº“éƒ¨ç½²

#### å¼€å‘æœºå™¨ï¼š

```bash
# 1. æž„å»ºé•œåƒ
cd dashboard
vim build-images.sh  # ä¿®æ”¹ REGISTRY="harbor.company.com/dashboard"
./build-images.sh v1.0.0
# é€‰æ‹© y æŽ¨é€
```

#### æœåŠ¡å™¨ï¼š

```bash
# 1. å‡†å¤‡çŽ¯å¢ƒ
mkdir -p /opt/dashboard
cd /opt/dashboard

# 2. åˆ›å»º docker-compose.yml
cat > docker-compose.yml << 'EOF'
version: '3.8'
services:
  backend:
    image: harbor.company.com/dashboard/dashboard-backend:v1.0.0
    container_name: dashboard-backend
    ports:
      - "3001:3001"
    env_file:
      - .env
    restart: always
    networks:
      - dashboard-network
  frontend:
    image: harbor.company.com/dashboard/dashboard-frontend:v1.0.0
    container_name: dashboard-frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    restart: always
    networks:
      - dashboard-network
networks:
  dashboard-network:
    driver: bridge
EOF

# 3. åˆ›å»º .env æ–‡ä»¶
vim .env
# å¡«å…¥é…ç½®...

# 4. ç™»å½•å¹¶æ‹‰å–é•œåƒ
docker login harbor.company.com
docker-compose pull

# 5. å¯åŠ¨æœåŠ¡
docker-compose up -d

# 6. éªŒè¯
docker-compose ps
curl http://localhost:3001/health
```

---

## ðŸŽ‰ éƒ¨ç½²å®Œæˆ

çŽ°åœ¨ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®æœåŠ¡ï¼š

- å‰ç«¯é¡µé¢ï¼šhttp://æœåŠ¡å™¨IP
- åŽç«¯ APIï¼šhttp://æœåŠ¡å™¨IP:3001

å¦‚éœ€å¸®åŠ©ï¼Œè¯·æŸ¥çœ‹ï¼š
- [DOCKER_DEPLOYMENT.md](./DOCKER_DEPLOYMENT.md) - è¯¦ç»†éƒ¨ç½²æ–‡æ¡£
- [DEPLOYMENT.md](./DEPLOYMENT.md) - é€šç”¨éƒ¨ç½²æŒ‡å—
